<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Chat app with Deno</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="app.css" />
  </head>

  <body>
    <div class="chat-container">
      <div class="chat-sidebar">
        <h3>Room users (<span id="chatUsersCount">123</span>)</h3>
        <div id="chatUsers" class="chat-users"></div>
      </div>
      <div class="chat-main">
        <div class="chat-header">
          <div id="groupName" class="group-name">
            Javascript
          </div>
          <div>
            <button id="leaveGroupBtn">Leave group</button>
          </div>
        </div>
        <div class="chat-messages">
          <div class="message message-from">
            <h4>John</h4>
            <p class="message-text">Lorem ipsum smth</p>
          </div>
          <div class="message message-from">
            <h4>John</h4>
            <p class="message-text">Lorem ipsum smth</p>
          </div>
          <div class="message message-from">
            <h4>John</h4>
            <p class="message-text">Lorem ipsum smth</p>
          </div>
          <div class="message message-from">
            <h4>John</h4>
            <p class="message-text">Lorem ipsum smth</p>
          </div>
          <div class="message message-from">
            <h4>John</h4>
            <p class="message-text">Lorem ipsum smth</p>
          </div>
          <div class="message message-from">
            <h4>John</h4>
            <p class="message-text">Lorem ipsum smth</p>
          </div>
          <div class="message message-from">
            <h4>John</h4>
            <p class="message-text">Lorem ipsum smth</p>
          </div>
          <div class="message message-from">
            <h4>John</h4>
            <p class="message-text">Lorem ipsum smth</p>
          </div>
          <div class="message message-to">
            <p class="message-text">Hi</p>
          </div>
        </div>
        <div class="chat-footer">
          <form id="messageSendForm">
            <input type="text" placeholder="Type message and hit enter" />
            <button>Send</button>
          </form>
        </div>
      </div>
    </div>

    <!-- <script src="client.js"></script> -->
    <script>
      var ws;
      var chatUsersCtr = document.querySelector('#chatUsers');
      window.addEventListener('DOMContentLoaded', function () {
        ws = new WebSocket('ws://localhost:3000/ws');
        ws.addEventListener('open', onConnectionOpen);
        ws.addEventListener('message', onMessageReceived);
      });

      function onConnectionOpen() {
        console.log('Connection Opened');
        var queryParams = getQueryParams();

        if (!queryParams.name || !queryParams.group) {
          window.location.href = 'chat.html';
          return;
        }
        var event = {
          event: 'join',
          groupName: queryParams.group,
          name: queryParams.name
        };
        ws.send(JSON.stringify(event));
      }

      function onMessageReceived(event) {
        console.log('Connection Received');
        event =
          typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
        console.log('Data : ', event);

        switch (event.event) {
          case 'users':
            chatUsersCtr.innerHTML = '';
            event.data.forEach((u) => {
              var userEl = document.createElement('div');
              userEl.className = 'chat-user';
              userEl.innerHTML = u.name;

              chatUsersCtr.appendChild(userEl);
            });
            break;

          default:
            break;
        }
      }

      function getQueryParams() {
        var search = window.location.search.substring(1);
        var pairs = search.split('&');
        var params = {};
        for (var pair of pairs) {
          var parsts = pair.split('=');
          params[decodeURIComponent(parsts[0])] = decodeURIComponent(parsts[1]);
        }

        return params;
      }
    </script>
  </body>
</html>
